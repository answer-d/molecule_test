# moleculeに入門してみたよ

moleculeはAnsible Roleをテストするためのツール
moleculeは分子って意味らしい

pythonモジュールで実装されているので、`pip install molecule`で使える
使い方もとってもかんたん → 「molecule test」
これで、

- Playbookが正しい構文になっているよね、コードがある規則に基づいて記述されているよね、を確認する(lint)
- dockerコンテナを立てて、作成したPlaybookを流す
- もう一度同じPlaybookを流して冪等になっているか確認
- 事前にかいていたテストを実行して、狙い通りの動きをしているかチェック

みたいなことをやってくれる
つまりAnsible Roleのテスト自動化ができるツール
もちろんテストの内容やtestコマンド実行時の動作はカスタマイズできる

## なにがうれしいのよ

Ansible Roleは一回書いて終わりじゃなくて、何度も修正していくはず
そんな中で、何度もRoleの動作が正しいことを手で確認するのは大変であることは明らか
こんなときに、moleculeのようなテスト自動化が役に立つ

テストが自動化されていれば、人間が毎回毎回手でRoleの正しさを保証する必要がなくなって楽だし、機械がテストをしてくれるので定義された試験項目をもれなく実施できる、これって人間がやるよりもデグレードしにくいよね(人類の場合はサボる)
更に、Roleをgitみたいなバージョン管理ツールに入れておいて、コードに修正が入ったとき自動でテストが流れるようなパイプラインを作れば、コード修正時にテストを自動化するといったこともできて素晴らしい
あと実は構文チェックとかlintとかって、実は毎回人間が手でやるのめんどくさいんですよね、「あってるやろー」って突き進んであっ…みたいなのはよくある話で、機械的に救うのは理にかなってる

要するに、IaCをするなら色々な面を考えるとテストは自動化されているべきで、それをAnsible Roleにおいて実現してくれるのがmoleculeだよ、って話

## ロールを作ってみる

```console
# molecule init role -r apache_vhost
```

ansible engineの方の教材の一番最後にhttpdを作るRoleがあったので借用

- とりあえずがーっと作ってmolecule test実行してみた
  - serviceでこける…
    - DBUS関連っぽいので、コンテナはprivilegedであげて、/sbin/initコマンドで起動させるように修正
    - molecule.yml修正して、serviceモジュールでなくsystemdモジュールにした

できたー

- verifierをtestinfraからansibleにしてみる

## おまけ

- molecule testで実行される一部のシーケンスだけ取り出して実行することもできるので、初回作成時も結構うれしい
  - dockerコンテナ上げて動作テストしながらーって手でやるとまぁまぁ手間だけど、Moleculeならいい感じにしてくれていい感じ
  - 作ったコンテナにログインしてくれるコマンドとかもある、vagrant sshみたいな感じで、サーバの状態確認するときラクラクの楽

- テストコードはtestinfraだけでなく、ansibleでもかけるっぽい
  - testinfraだとpythonになってしまうので、プログラムかけないインフラマンもこれならいけるのでは？
  - ansible自身にもテスト用モジュールはちゃんとある、ポートチェックとかどうやるの？って思ったら`wait_for`とかあった、さすが
